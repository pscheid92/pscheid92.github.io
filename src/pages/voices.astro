---
import Layout from '../layouts/Layout.astro';
---

<Layout
        title="Browser Voices - Available Speech Synthesis Voices"
        description="Explore the available speech synthesis voices in your browser using the Web Speech API."
    >
        <style is:global>
            .voices-header {
                text-align: center;
                margin: 3em 0 2em;
            }
            /* Ensure the page heading is visible (avoid white-on-white) */
            .voices-header h1,
            .prose .voices-header h1 {
                color: rgb(var(--black)) !important;
            }

            .prose {
                margin: auto;
                padding: 1em;
                color: rgb(var(--gray-dark));
                max-width: 1100px;
            }

            /* Container for rounded corners and shadow */
            #voices-container {
                width: 100%;
                margin: 2em 0;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                border: 1px solid rgb(var(--gray-light) / 0.2);
                background: white;
                overflow-x: auto; /* allow horizontal scroll if needed */
                -webkit-overflow-scrolling: touch;
                /* add breathing room so content doesn't touch the rounded edges */
                padding: 0.75rem 1rem;
                background-clip: padding-box;
            }

            .voices-table {
                width: 100%;
                /* Use separate borders for reliable vertical dividers */
                border-collapse: separate;
                border-spacing: 0;
                font-size: 0.95em;
            }

            .voices-table thead th {
                /* Use the usual background with strong readable text */
                background: white !important;
                color: rgb(var(--black)) !important;
                padding: 1.2em 1.5em;
                text-align: left;
                font-weight: 700;
                font-size: 0.9em;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                white-space: nowrap;
                position: sticky;
                top: 0;
                z-index: 1;
                box-shadow: 0 1px 0 rgba(0,0,0,0.06);
                border-bottom: 1px solid rgb(var(--gray-light) / 0.5);
            }

            /* Add borders between cells (vertical) and a subtle table outline */
            .voices-table {
                border: 1px solid rgb(var(--gray-light) / 0.5);
            }
            .voices-table th,
            .voices-table td {
                border-right: 1px solid rgb(var(--gray-light) / 0.5);
            }
            .voices-table th:last-child,
            .voices-table td:last-child {
                border-right: none;
            }

            .voices-table td {
                padding: 1.2em 1.5em;
                border-bottom: 1px solid rgb(var(--gray-light) / 0.2);
                vertical-align: top;
                /* transparent so zebra striping on rows remains visible */
                background: transparent;
            }

            .voices-table tbody tr:last-child td {
                border-bottom: none;
            }

            .voices-table tbody tr:nth-child(even) {
                background: rgb(var(--gray-light) / 0.05);
            }

            .voices-table tbody tr:hover {
                background: color-mix(in srgb, var(--accent) 4%, transparent);
                transition: background 0.2s ease;
            }

            /* Improve column alignment (now 4 columns total) */
            .voices-table tbody td:nth-child(2),
            .voices-table thead th:nth-child(2),
            .voices-table tbody td:nth-child(3),
            .voices-table thead th:nth-child(3),
            .voices-table tbody td:nth-child(4),
            .voices-table thead th:nth-child(4) {
                text-align: center;
                white-space: nowrap;
            }

            .lang-code {
                font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
                font-weight: 700;
                color: var(--accent);
                background: color-mix(in srgb, var(--accent) 10%, transparent);
                padding: 0.2em 0.5em;
                border-radius: 4px;
                font-size: 0.85em;
            }

            /* Small count badge */
            .count-badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 2.1em;
                padding: 0.15em 0.6em;
                border-radius: 999px;
                font-weight: 700;
                font-size: 0.85em;
                color: var(--accent);
                background: color-mix(in srgb, var(--accent) 12%, transparent);
                border: 1px solid color-mix(in srgb, var(--accent) 22%, transparent);
            }

            /* Toolbar for totals and download */
            .voices-toolbar {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 1rem;
                padding: 0.25rem 0.25rem 0.75rem;
            }
            .voices-toolbar .summary {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            .voices-toolbar .chip {
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
                padding: 0.25rem 0.6rem;
                border-radius: 999px;
                font-weight: 700;
                font-size: 0.85em;
                color: rgb(var(--black));
                background: rgb(var(--gray-light) / 0.4);
                border: 1px solid rgb(var(--gray-light) / 0.7);
            }
            .voices-toolbar .download-btn {
                padding: 0.45rem 0.8rem;
                border-radius: 8px;
                border: 1px solid color-mix(in srgb, var(--accent) 45%, #0000);
                background: color-mix(in srgb, var(--accent) 10%, white);
                color: rgb(var(--black));
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s ease, border-color 0.2s ease;
                white-space: nowrap;
            }
            .voices-toolbar .download-btn:hover {
                background: color-mix(in srgb, var(--accent) 16%, white);
                border-color: color-mix(in srgb, var(--accent) 60%, #0000);
            }

            /* Badge styles for Yes/No */
            .badge {
                display: inline-block;
                padding: 0.2em 0.6em;
                border-radius: 999px;
                font-size: 0.8em;
                font-weight: 600;
                line-height: 1.2;
            }
            .badge-yes {
                color: rgb(22 101 52);
                background: rgb(187 247 208 / 0.8);
                border: 1px solid rgb(134 239 172 / 0.8);
            }
            .badge-no {
                color: rgb(153 27 27);
                background: rgb(254 226 226 / 0.8);
                border: 1px solid rgb(254 202 202 / 0.8);
            }

            .loading {
                text-align: center;
                padding: 4em 2em;
                color: rgb(var(--gray));
                font-style: italic;
            }

            .error {
                padding: 1.5em;
                margin: 2em 0;
                background: rgb(254 242 242);
                border: 1px solid rgb(239 68 68 / 0.2);
                border-radius: 8px;
                color: rgb(185 28 28);
                text-align: center;
            }

            /* Responsive adjustment for small screens */
            @media (max-width: 768px) {
                #voices-container {
                    overflow-x: auto;
                }
                .voices-table {
                    min-width: 600px;
                }
            }
        </style>

    <article class="prose">
        <div class="voices-header">
            <h1>Browser Voices</h1>
            <p>Available speech synthesis voices in your browser</p>
        </div>

        <div id="voices-container">
            <div class="loading">Loading available voices...</div>
        </div>
    </article>

    <script>
        function displayVoices(voices: SpeechSynthesisVoice[]) {
            const container = document.getElementById('voices-container');
            if (!container) return;

            if (voices.length === 0) {
                container.innerHTML = '<p class="loading">No voices available in your browser.</p>';
                return;
            }

            // Group voices by language
            const languageMap = new Map<string, SpeechSynthesisVoice[]>();
            voices.forEach(voice => {
                if (!languageMap.has(voice.lang)) {
                    languageMap.set(voice.lang, []);
                }
                languageMap.get(voice.lang)!.push(voice);
            });

            // Sort languages
            const sortedLanguages = Array.from(languageMap.keys()).sort();

            const totalLanguages = sortedLanguages.length;
            const totalVoices = voices.length;

            // Create table
            const table = document.createElement('table');
            table.className = 'voices-table';

            // Create header
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Language</th>
                    <th>Voice Count</th>
                    <th>Local</th>
                    <th>Default</th>
                </tr>
            `;
            table.appendChild(thead);

            // Create body
            const tbody = document.createElement('tbody');
            sortedLanguages.forEach(lang => {
                const langVoices = languageMap.get(lang)!;
                const row = document.createElement('tr');
                const hasLocal = langVoices.some(v => v.localService);
                const hasDefault = langVoices.some(v => v.default);

                row.innerHTML = `
                    <td><span class="lang-code">${lang}</span></td>
                    <td><span class="count-badge" aria-label="${langVoices.length} voices">${langVoices.length}</span></td>
                    <td>${hasLocal ? '<span class="badge badge-yes">Yes</span>' : '<span class="badge badge-no">No</span>'}</td>
                    <td>${hasDefault ? '<span class="badge badge-yes">Yes</span>' : '<span class="badge badge-no">No</span>'}</td>
                `;

                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            // Build toolbar with totals and download button
            const toolbar = document.createElement('div');
            toolbar.className = 'voices-toolbar';
            toolbar.innerHTML = `
                <div class="summary">
                    <span class="chip" title="Total languages">Languages: <strong>${totalLanguages}</strong></span>
                    <span class="chip" title="Total voices">Voices: <strong>${totalVoices}</strong></span>
                </div>
                <button type="button" class="download-btn" aria-label="Download voices JSON">Download JSON</button>
            `;

            container.innerHTML = '';
            container.appendChild(toolbar);
            container.appendChild(table);

            // Wire up download button
            const downloadBtn = toolbar.querySelector<HTMLButtonElement>('.download-btn');
            downloadBtn?.addEventListener('click', () => {
                const payload = {
                    generatedAt: new Date().toISOString(),
                    totals: { languages: totalLanguages, voices: totalVoices },
                    languages: sortedLanguages.map((lang) => {
                        const list = languageMap.get(lang)!;
                        return {
                            language: lang,
                            count: list.length,
                            voices: list.map(v => ({
                                name: v.name,
                                lang: v.lang,
                                localService: v.localService,
                                default: (v as any).default ?? false,
                                voiceURI: v.voiceURI
                            }))
                        };
                    })
                };

                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'voices.json';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            });
        }

        function loadVoices() {
            const container = document.getElementById('voices-container');

            if (!('speechSynthesis' in window)) {
                if (container) {
                    container.innerHTML = '<div class="error">Speech Synthesis API is not supported in your browser.</div>';
                }
                return;
            }

            const voices = window.speechSynthesis.getVoices();

            if (voices.length > 0) {
                displayVoices(voices);
            } else {
                // Some browsers load voices asynchronously
                window.speechSynthesis.onvoiceschanged = () => {
                    const voices = window.speechSynthesis.getVoices();
                    displayVoices(voices);
                };
            }
        }

        // Load voices when the page loads
        loadVoices();
    </script>
</Layout>
